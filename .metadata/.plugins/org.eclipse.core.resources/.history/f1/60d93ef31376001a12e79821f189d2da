/*
 * sunlight_sensor.c
 *
 *  Created on: Mar 30, 2020
 *      Author: Nuoya
 */

#include "sunlight_sensor.h"

void configure_sunlight_sensor(void)
{
    //configure and enable UV reading
    //These registers must be set specific numbers
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_UCOEFF0, 0x29);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_UCOEFF1, 0x89);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_UCOEFF2, 0x02);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_UCOEFF3, 0x00);
    __delay_cycles(5000);

    //write to pararmeter register to enable UV and VIS
    write_sunlight_parameter_data(ST114X_CHILIST,
    SI114X_CHLIST_ENUV | SI114X_CHLIST_ENALSVIS | SI114X_CHLIST_ENALSIR);

    //set VIS ADC Setting - set to under direct sunlight
    write_sunlight_parameter_data(SI114X_ALS_VIS_ADC_GAIN,
    SI114X_ADC_GAIN_DIV1);
    write_sunlight_param_data(SI114X_ALS_VIS_ADC_COUNTER,
    SI114X_ADC_COUNTER_511ADCCLK);
    write_sunlight_param_data(SI114X_ALS_VIS_ADC_MISC,
    SI114X_ADC_MISC_HIGHRANGE);

    //Set IR ADC setting - set to under direct sunlight
    write_sunlight_parameter_data(SI114X_ALS_IR_ADC_GAIN, SI114X_ADC_GAIN_DIV1);
    write_sunlight_parameter_data(SI114X_ALS_IR_ADC_COUNTER,
    SI114X_ADC_COUNTER_511ADCCLK);
    write_sunlight_parameter_data(SI114X_ALS_IR_ADC_MISC,
    SI114X_ADC_MISC_HIGHRANGE);

    //interrupt enable
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_INT_CFG, SI114X_INT_CFG_INTOE);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_IRQ_ENABLE, SI114X_IRQEN_ALS);

    //Auto Run - Need to change to manual mode
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_MEAS_RATE0, 0xFF);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_COMMAND, SI114X_PSALS_AUTO);
}

uint8_t write_sunlight_param_data(uint8_t reg, uint8_t value)
{
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_WR, value);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_CMD, reg | SI114X_SET);
    __delay_cycles(5000);
    I2C_receive_msg(SUNLIGHT_SENSOR_ADDR, SI114X_RD, 1);
    __delay_cycles(5000);
    //read back to see if it is right
    return ReceiveBuffer[0];
}

void reset_sunlight_sensor(void)
{
    //These registes will need to be cleared
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_MEAS_RATE0, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_MEAS_RATE1, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_IRQ_ENABLE, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_IRQ_MODE1, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_IRQ_MODE2, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_INT_CFG, 0x0);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_IRQ_STATUS, 0xFF);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_COMMAND, SI114X_RESET);
    __delay_cycles(5000);
    I2C_send_byte(SUNLIGHT_SENSOR_ADDR, SI114X_HW_KEY, 0x17);
    __delay_cycles(5000);
}

void read_sunlight_VIS(uint16_t* data)
{
    I2C_receive_msg(SUNLIGHT_SENSOR_ADDR, SI114X_ALS_VIS_DATA0, 2); //read VIS_DATA
    *data = ReceiveBuffer[1] << 8 | ReceiveBuffer[0];
    __delay_cycles(5000);
}

void read_sunlight_IR(uint16_t* data)
{
    I2C_receive_msg(SUNLIGHT_SENSOR_ADDR, SI114X_ALS_IR_DATA0, 2); //read IR_DATA
    *data = ReceiveBuffer[1] << 8 | ReceiveBuffer[0];
    __delay_cycles(5000);
}

void read_sunlight_UV(uint16_t* data)
{
    I2C_Master_ReadReg(SUNLIGHT_SENSOR_ADDR, 0x24, 2); //read VIS_DATA

       __delay_cycles(100);

       I2C_Master_ReadReg(0x60, 0x2C, 2); //read VIS_DATA

       __delay_cycles(10000);
}
